# 数据库脚本说明

本目录包含用于初始化和维护数据库的脚本文件。

## 脚本列表

### 1. init-merchant.js
**功能**: 创建默认商家账号

**使用方法**:
```bash
node scripts/init-merchant.js
```

**说明**:
- 创建默认管理员账号（用户名: `admin`, 密码: `admin123`）
- 包含完整的门店信息配置（配送费、免配送费门槛等）
- 如果账号已存在，则跳过创建
- ⚠️ **首次登录后请立即修改密码！**

### 2. init-merchant-custom.js
**功能**: 自定义创建商家账号

**使用方法**:
```bash
node scripts/init-merchant-custom.js
```

**说明**:
- 可以修改脚本中的 `merchantConfig` 配置来创建自定义商家账号
- 支持自定义用户名、密码、商家名称、门店信息等
- 支持配置配送费、免配送费门槛等完整门店信息
- 如果用户名已存在，会提示错误

### 3. init-data.js
**功能**: 初始化基础数据（分类、商品、优惠券）

**使用方法**:
```bash
node scripts/init-data.js
```

**说明**:
- 创建商品分类（经典面筋、特色套餐、加料小食、饮品）
- 创建示例商品数据
- 创建示例优惠券数据
- 创建积分商品（积分商城）
- 创建商品券
- 如果数据已存在，则跳过创建

### 4. init-full-data.js
**功能**: 初始化完整测试数据

**使用方法**:
```bash
node scripts/init-full-data.js
```

**说明**:
- 创建完整的测试数据，包括：
  - 商户信息
  - 商品分类和商品
  - 特价套餐
  - 优惠券
  - 积分商品（积分商城）
  - 商品券
  - 测试用户
  - 用户地址
  - 购物车数据
  - 订单数据
  - 评价数据
  - 用户优惠券
  - 用户商品券
  - 用户积分记录
- 适用于开发和测试环境

### 5. fix-user-index.js
**功能**: 修复用户集合的索引问题

**使用方法**:
```bash
node scripts/fix-user-index.js
```

**说明**:
- 清理旧的 `openId` 索引
- 确保 `openid` 字段的唯一索引存在
- 清理无效的用户记录

### 6. fix-cart-index.js
**功能**: 修复购物车集合的索引问题

**使用方法**:
```bash
node scripts/fix-cart-index.js
```

**说明**:
- 清理旧的 `user` 索引
- 确保 `userId` 和复合索引存在
- 清理无效的购物车记录

## 使用建议

### 首次部署
1. 先运行 `init-merchant.js` 创建管理员账号
2. 运行 `init-data.js` 创建基础数据
3. 如需完整测试数据，运行 `init-full-data.js`

### 数据库维护
- 如果遇到索引相关错误，运行相应的 `fix-*.js` 脚本
- 修复脚本会安全地处理已存在的索引

## 注意事项

1. **环境变量**: 所有脚本都需要 `.env` 文件中的 `MONGODB_URI` 配置
2. **数据库连接**: 脚本执行完成后会自动关闭数据库连接
3. **数据安全**: 生产环境使用前请仔细检查脚本内容
4. **密码安全**: 默认密码仅用于开发环境，生产环境请使用强密码

## 错误处理

所有脚本都包含错误处理：
- 数据库连接失败会显示错误信息并退出
- 数据创建失败会显示详细错误信息
- 脚本执行完成后会正确关闭数据库连接
