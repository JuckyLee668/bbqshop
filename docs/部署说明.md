# 手工烤面筋项目部署说明

## 项目结构

```
miniprogram-5/
├── miniprogram/          # 微信小程序前端
├── server/               # Node.js 后端 API
├── admin/                # Vue3 管理后台
└── docs/                 # 项目文档
```

---

## 一、后端服务部署

### 1.1 环境要求
- Node.js >= 16.0.0 (推荐 18.x LTS)
- MongoDB >= 4.4.0
- PM2 (生产环境进程管理)

### 1.2 安装步骤

```bash
# 进入后端目录
cd server

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件，填写配置信息

# 启动 MongoDB（确保 MongoDB 服务已启动）

# 开发模式启动
npm run dev

# 生产模式启动
npm start
```

### 1.3 环境变量配置

编辑 `server/.env` 文件：

```env
PORT=3000
MONGODB_URI=mongodb://localhost:27017/noodles_db
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRE=7d
WX_APPID=your_wechat_appid
WX_SECRET=your_wechat_secret
```

### 1.4 初始化数据

启动服务后，需要创建初始数据：

1. **创建商家账号**（可以通过 API 或直接插入数据库）
2. **创建商品分类**
3. **创建商品数据**

---

## 二、小程序配置

### 2.1 修改 API 地址

编辑 `miniprogram/utils/api.js`：

```javascript
const BASE_URL = 'https://your-api-domain.com/v1'; // 修改为实际的后端地址
```

### 2.2 配置微信小程序

1. 在微信公众平台配置服务器域名
2. 将后端 API 地址添加到 request 合法域名
3. 配置 uploadFile 合法域名（如果需要上传图片）

### 2.3 编译运行

1. 使用微信开发者工具打开 `miniprogram` 目录
2. 配置 AppID
3. 编译运行

---

## 三、管理后台部署

### 3.1 环境要求
- Node.js >= 16.0.0
- npm 或 yarn

### 3.2 安装步骤

```bash
# 进入管理后台目录
cd admin

# 安装依赖
npm install

# 配置环境变量
# 编辑 .env.development 和 .env.production

# 开发模式启动
npm run dev

# 生产模式构建
npm run build
```

### 3.3 环境变量配置

编辑 `admin/.env.development`（开发环境）：
```
VITE_API_BASE_URL=http://localhost:3000/v1
```

编辑 `admin/.env.production`（生产环境）：
```
VITE_API_BASE_URL=https://your-api-domain.com/v1
```

### 3.4 部署到服务器

构建完成后，将 `admin/dist` 目录部署到 Web 服务器（如 Nginx）。

---

## 四、数据库初始化

### 4.1 创建商家账号

可以通过 API 或直接插入数据库：

```javascript
// 使用 MongoDB shell 或工具
db.merchants.insertOne({
  username: 'admin',
  password: '$2a$10$...', // bcrypt 加密后的密码
  name: '夜市烤面筋',
  storeInfo: {
    name: '夜市烤面筋',
    address: '夜市美食街A区12号摊位',
    businessHours: '09:00-23:00',
    deliveryRange: 3,
    status: 'open'
  }
})
```

### 4.2 创建初始分类

```javascript
db.categories.insertMany([
  { name: '原味', sort: 1 },
  { name: '香辣', sort: 2 },
  { name: '孜然', sort: 3 },
  { name: '套餐', sort: 4 }
])
```

---

## 五、生产环境部署建议

### 5.1 后端服务

1. **使用 PM2 管理进程**：
```bash
npm install -g pm2
pm2 start app.js --name noodles-api
pm2 save
pm2 startup
```

2. **使用 Nginx 反向代理**：
```nginx
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

3. **配置 HTTPS**（使用 Let's Encrypt）

### 5.2 数据库

1. 配置 MongoDB 副本集（生产环境）
2. 定期备份数据库
3. 设置数据库访问权限

### 5.3 安全配置

1. 使用 HTTPS
2. 配置 CORS 白名单
3. 设置防火墙规则
4. 定期更新依赖包

---

## 六、常见问题

### 6.1 小程序无法连接后端

- 检查后端服务是否启动
- 检查网络请求域名是否在微信公众平台配置
- 检查 API 地址是否正确

### 6.2 管理后台无法登录

- 检查后端 API 地址配置
- 检查商家账号是否创建
- 查看浏览器控制台错误信息

### 6.3 数据库连接失败

- 检查 MongoDB 服务是否启动
- 检查连接字符串是否正确
- 检查数据库访问权限

---

## 七、开发流程

1. **启动后端服务**：`cd server && npm run dev`
2. **启动管理后台**：`cd admin && npm run dev`
3. **打开小程序**：使用微信开发者工具打开 `miniprogram` 目录

---

## 八、API 测试

可以使用 Postman 或类似工具测试 API：

1. 导入 API 文档中的接口
2. 配置环境变量（baseURL、token 等）
3. 测试各个接口功能
