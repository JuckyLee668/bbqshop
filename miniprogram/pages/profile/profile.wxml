<view class="profile-container">
  <!-- 未登录状态：一键登录 -->
  <view wx:if="{{!isLoggedIn}}" class="login-banner">
    <view class="login-content">
      <t-icon name="user" size="80px" color="#fff" />
      <text class="login-title">欢迎使用手工烤面筋</text>
      <text class="login-desc">一键登录，享受便捷服务</text>
      <button 
        class="login-button"
        bindtap="handleOneClickLogin"
        loading="{{loginLoading}}"
        disabled="{{loginLoading}}"
      >
        <t-icon name="wechat" size="20px" color="#FF6B35" />
        <text style="margin-left: 8px;">微信一键登录</text>
      </button>
      <text class="login-tip">点击登录即表示同意用户协议和隐私政策</text>
    </view>
  </view>

  <!-- 已登录状态：用户信息区域 -->
  <view wx:else class="user-banner">
    <view class="user-info" bindtap="editUserInfo">
      <view class="avatar-wrapper">
        <image wx:if="{{userInfo && userInfo.avatarUrl}}" src="{{userInfo.avatarUrl}}" class="avatar-image" />
        <t-icon wx:else name="user" size="40px" color="#FF6B35" />
      </view>
      <view class="user-details">
        <text class="user-name">{{userInfo ? userInfo.nickName : '微信用户'}}</text>
        <text class="user-phone">手机号：{{userInfo ? userInfo.phone : '未绑定'}}</text>
        <text class="user-openid" wx:if="{{userInfo && userInfo.openid}}">微信ID：{{userInfo.openid}}</text>
      </view>
      <t-icon name="chevron-right" size="20px" color="#fff" />
    </view>
    <view class="user-stats">
      <view class="stat-item">
        <text class="stat-value">{{stats.orderCount}}</text>
        <text class="stat-label">订单数</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">¥{{stats.totalConsumption}}</text>
        <text class="stat-label">累计消费</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.points}}</text>
        <text class="stat-label">积分</text>
      </view>
    </view>
  </view>

  <!-- 我的订单（仅登录后显示） -->
  <view wx:if="{{isLoggedIn}}" class="order-section">
    <view class="section-header">
      <text class="section-title">我的订单</text>
      <view class="section-more" bindtap="viewAllOrders">
        <text>查看全部</text>
        <t-icon name="chevron-right" size="16px" color="#999" />
      </view>
    </view>
    <view class="order-grid">
      <view class="order-item" bindtap="viewOrders" data-status="pending">
        <view class="order-icon-wrapper">
          <t-icon name="time" size="32px" color="#FF6B35" />
          <view wx:if="{{orderStats.pending > 0}}" class="order-icon-badge">{{orderStats.pending}}</view>
        </view>
        <text class="order-label">待制作</text>
      </view>
      <view class="order-item" bindtap="viewOrders" data-status="making">
        <view class="order-icon-wrapper">
          <t-icon name="loading" size="32px" color="#1890ff" />
          <view wx:if="{{orderStats.making > 0}}" class="order-icon-badge">{{orderStats.making}}</view>
        </view>
        <text class="order-label">制作中</text>
      </view>
      <view class="order-item" bindtap="viewOrders" data-status="completed">
        <view class="order-icon-wrapper">
          <t-icon name="check-circle" size="32px" color="#52c41a" />
          <view wx:if="{{orderStats.completed > 0}}" class="order-icon-badge">{{orderStats.completed}}</view>
        </view>
        <text class="order-label">已完成</text>
      </view>
      <view class="order-item" bindtap="viewOrders" data-status="cancelled">
        <view class="order-icon-wrapper">
          <t-icon name="close-circle" size="32px" color="#999" />
          <view wx:if="{{orderStats.cancelled > 0}}" class="order-icon-badge">{{orderStats.cancelled}}</view>
        </view>
        <text class="order-label">已取消</text>
      </view>
    </view>
  </view>

  <!-- 功能菜单（仅登录后显示） -->
  <t-cell-group wx:if="{{isLoggedIn}}">
    <t-cell 
      title="我的地址" 
      left-icon="location"
      arrow
      bind:click="goToAddress"
    />
    <t-cell 
      title="优惠券" 
      left-icon="check-circle"
      note="3张可用"
      arrow
      bind:click="goToCoupons"
    />
    <t-cell 
      title="积分商城" 
      left-icon="wallet"
      arrow
      bind:click="goToPoints"
    />
    <t-cell 
      title="联系客服" 
      left-icon="chat"
      arrow
      bind:click="contactService"
    />
    <t-cell 
      title="意见反馈" 
      left-icon="feedback"
      arrow
      bind:click="goToFeedback"
    />
  </t-cell-group>

  <!-- 用户信息编辑弹窗 -->
  <view class="edit-modal" wx:if="{{showEditModal}}" bindtap="closeEditModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">编辑资料</text>
        <t-icon name="close" size="24px" color="#999" bindtap="closeEditModal" />
      </view>
      
      <view class="modal-body">
        <!-- 头像选择 -->
        <view class="form-item">
          <text class="form-label">头像</text>
          <button class="avatar-button" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
            <image wx:if="{{editForm.avatarUrl}}" src="{{editForm.avatarUrl}}" class="avatar-preview" />
            <view wx:else class="avatar-placeholder">
              <t-icon name="user" size="40px" color="#999" />
              <text>点击选择头像</text>
            </view>
          </button>
        </view>

        <!-- 昵称输入 -->
        <view class="form-item">
          <text class="form-label">昵称</text>
          <input 
            class="nickname-input" 
            type="nickname" 
            placeholder="请输入昵称"
            value="{{editForm.nickName}}"
            bindblur="onNicknameBlur"
          />
        </view>

        <!-- 手机号绑定 -->
        <view class="form-item">
          <text class="form-label">手机号</text>
          <view class="phone-wrapper">
            <text class="phone-text">{{editForm.phone || '未绑定'}}</text>
            <button 
              class="bind-phone-btn" 
              open-type="getPhoneNumber" 
              bindgetphonenumber="onGetPhoneNumber"
            >
              {{editForm.phone ? '重新绑定' : '绑定手机号'}}
            </button>
          </view>
        </view>

        <!-- 微信ID显示（只读） -->
        <view class="form-item" wx:if="{{editForm.openid}}">
          <text class="form-label">微信ID</text>
          <text class="readonly-text">{{editForm.openid}}</text>
        </view>
      </view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeEditModal">取消</button>
        <button class="save-btn" bindtap="saveUserInfo">保存</button>
      </view>
    </view>
  </view>
</view>
